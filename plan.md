# Next.js App Router + MUI デバイス別出し分け手法 比較実験計画

## 1. 実験概要

### 目的
- Next.js App Router + MUIにおけるPC/モバイル出し分け手法のパフォーマンス比較
- 静的レンダリングとデバイス最適化のトレードオフ検証
- 各手法の実装コストと保守性の評価

### 前提条件
- Next.js 14.2.4 App Router
- Material-UI (MUI) 5.x
- TypeScript
- 静的レンダリングの維持を重視

## 2. 実装する手法（4パターン）

### パターン1: CSSファーストアプローチ（推奨ベースライン）
**概要**: MUI `sx`プロパティによる純粋なレスポンシブデザイン

**特徴**:
- 単一URL、完全静的生成
- `sx={{ display: { xs: 'block', md: 'none' } }}`による表示制御
- CSSメディアクエリベース

**実装ファイル**: `/css-first`

### パターン2: 動的レンダリング（アンチパターン）
**概要**: `headers()`関数によるサーバーサイドUA検出

**特徴**:
- リクエストヘッダーからデバイス判定
- Server Componentでの条件分岐
- 動的レンダリング強制（静的レンダリング無効化）

**実装ファイル**: `/dynamic-rendering`

### パターン3: Middlewareハイブリッド
**概要**: Middlewareでデバイス検出、内部リライトで静的配信

**特徴**:
- Middlewareでの事前デバイス判定
- ルートグループ `(mobile)` / `(desktop)` への内部リライト
- デバイス別静的ページ生成

**実装ファイル**: `/middleware-hybrid`

### パターン4: useMediaQueryフック
**概要**: クライアントサイドでのデバイス判定

**特徴**:
- MUIのuseMediaQueryフックを使用
- ハイドレーションエラー対策あり/なし両方を実装
- クライアントサイドでの条件分岐

**実装ファイル**: `/use-media-query`

## 3. 測定指標

### パフォーマンス指標
- **Time to First Byte (TTFB)**
- **Largest Contentful Paint (LCP)**
- **First Contentful Paint (FCP)**
- **Cumulative Layout Shift (CLS)**
- **Total Blocking Time (TBT)**

### バンドルサイズ指標
- Initial HTML size
- JavaScript bundle size
- CSS bundle size
- Total transfer size

### 品質指標
- ハイドレーションエラーの有無
- UIちらつき（フリッカー）の有無
- 実装の複雑さ（コード行数、ファイル数）

## 4. 実験用サンプルアプリケーション

### ページ構成
```
ホームページ
├── ヘッダー
│   ├── PC: 横並びナビゲーション
│   └── モバイル: ハンバーガーメニュー
├── ヒーローセクション
│   ├── PC: 2カラムレイアウト（テキスト + 画像）
│   └── モバイル: 1カラムレイアウト（縦積み）
├── 商品一覧セクション
│   ├── PC: 3カラムグリッド
│   └── モバイル: 1カラムリスト
├── データ表示セクション
│   ├── PC: テーブル形式
│   └── モバイル: カード形式
└── フッター
    ├── PC: 4カラムレイアウト
    └── モバイル: 1カラムアコーディオン
```

### 技術仕様
- **フレームワーク**: Next.js 14 App Router
- **UIライブラリ**: MUI 5.x
- **言語**: TypeScript
- **スタイリング**: MUI sx プロパティ + CSS-in-JS
- **画像最適化**: Next.js Image コンポーネント

## 5. 測定環境

### デバイス・ブラウザ
- **モバイル**: Chrome Mobile (iPhone SE 375px)
- **デスクトップ**: Chrome Desktop (1920x1080)
- **タブレット**: iPad Air (768px)

### ネットワーク条件
- **Fast 3G**: 1.6Mbps, 150ms RTT
- **Slow 3G**: 400kbps, 400ms RTT
- **WiFi**: 100Mbps, 10ms RTT

### 測定ツール
- **Lighthouse CLI**: Core Web Vitals測定
- **Next.js Bundle Analyzer**: バンドルサイズ分析
- **Chrome DevTools**: パフォーマンス詳細分析

## 6. 実験手順

### Phase 1: プロジェクトセットアップ
1. Next.js + MUI プロジェクト作成
2. 共通コンポーネントとスタイル設定
3. 測定ツールの設定

### Phase 2: 各パターンの実装
1. **CSSファースト** (`/css-first`)
2. **動的レンダリング** (`/dynamic-rendering`)
3. **Middlewareハイブリッド** (`/middleware-hybrid`)
4. **useMediaQueryフック** (`/use-media-query`)

### Phase 3: パフォーマンス測定
1. 各パターンを複数回測定（n=5）
2. 異なるネットワーク条件での測定
3. モバイル・デスクトップ両方での測定

### Phase 4: 結果分析
1. 数値データの集計と統計分析
2. パフォーマンス比較レポート作成
3. 推奨事項の策定

## 7. 期待される成果

### 定量的成果
- 各手法のパフォーマンス指標比較表
- バンドルサイズ比較グラフ
- ネットワーク条件別パフォーマンス分析

### 定性的成果
- 実装の複雑さ・保守性評価
- ハイドレーションエラー・UIちらつき有無
- 開発体験（DX）の比較

### 実用的成果
- 手法選択の意思決定フローチャート
- 実装時のベストプラクティス集
- 各手法の適用シーナリオ

## 8. 実験の制約と注意事項

### 制約
- 実験は開発環境で実施（本番環境の完全再現は困難）
- 測定値には誤差が含まれる可能性
- ネットワーク条件は人工的にシミュレート

### 注意事項
- 各パターンで同一のコンテンツ・デザインを保証
- 測定時は他のプロセスを最小限に抑制
- 複数回測定による統計的妥当性の確保

## 9. 実施スケジュール

1. **セットアップ**: プロジェクト作成・環境構築
2. **実装**: 4パターンの実装
3. **測定**: パフォーマンステスト実行
4. **分析**: 結果分析とレポート作成
5. **まとめ**: 推奨事項と知見の整理

---

この実験により、Next.js App Router + MUI環境でのデバイス別出し分け手法について、理論だけでなく実際のパフォーマンスデータに基づいた実用的な知見を得ることができます。 
